<%= render DS::Dialog.new(width: :lg) do |dialog| %>
  <% dialog.with_header(title: t(".title", account_name: priorbank_account.name)) %>

  <% dialog.with_body do %>
    <% if sync.present? %>
      <div data-controller="sync-selector" data-sync-selector-base-url-value="<%= sync_details_priorbank_account_path(priorbank_account) %>">
        <%# Loading Spinner %>
        <div data-sync-selector-target="loading" class="hidden">
          <div class="flex flex-col items-center justify-center py-12">
            <%= icon('loader-circle', size: 'xl', class: 'animate-spin text-primary') %>
            <p class="text-sm text-secondary mt-4"><%= t(".loading_sync_details") %></p>
          </div>
        </div>

        <%# Content %>
        <div data-sync-selector-target="content" class="space-y-4">
          <%# Sync Selector %>
          <% if syncs.any? && syncs.count > 1 %>
            <div>
              <label class="text-xs font-medium text-secondary mb-1 block"><%= t(".select_sync") %></label>
              <select
                data-action="change->sync-selector#change"
                class="w-full px-3 py-2 text-sm border border-secondary rounded-lg bg-container text-primary focus:outline-none focus:ring-2 focus:ring-primary">
              <% syncs.each do |s| %>
                <option value="<%= s.id %>" <%= "selected" if s.id == sync.id %>>
                  <%= s.status.titleize %> -
                  <%= (s.completed_at || s.failed_at || s.syncing_at || s.pending_at || s.created_at).strftime('%b %d, %Y %H:%M:%S') %>
                  <% if s.data.present? && (s.data["window_start_date"].present? || s.data["window_end_date"].present?) %>
                    (<%= s.data["window_start_date"].present? ? Date.parse(s.data["window_start_date"]).strftime('%b %d, %Y') : '—' %>
                    →
                    <%= s.data["window_end_date"].present? ? Date.parse(s.data["window_end_date"]).strftime('%b %d, %Y') : '—' %>)
                  <% end %>
                  <% if s.error.present? %>
                    [Error]
                  <% elsif s.sync_stats.present? && (s.sync_stats["imported_transactions"].present? || s.sync_stats["imported_transfers"].present?) %>
                    - <%= s.sync_stats["imported_transactions"].to_i %> / <%= s.sync_stats["imported_transfers"].to_i %>
                  <% end %>
                </option>
              <% end %>
            </select>
          </div>
        <% end %>
        <%# Status Section %>
        <div>
          <h3 class="text-sm font-medium text-primary mb-2"><%= t(".status_section") %></h3>
          <dl class="space-y-1">
            <div class="flex justify-between py-1.5 border-b border-secondary">
              <dt class="text-sm text-secondary"><%= t(".status") %></dt>
              <dd class="text-sm font-medium">
                <span class="<%= sync.status == 'completed' ? 'text-success' : sync.status == 'failed' ? 'text-destructive' : sync.status == 'syncing' ? 'text-warning' : 'text-secondary' %>">
                  <%= sync.status.titleize %>
                </span>
              </dd>
            </div>

            <% relevant_timestamp = sync.completed_at || sync.failed_at || sync.syncing_at || sync.pending_at || sync.created_at %>
            <% relevant_label = sync.completed_at ? t(".completed_at") : sync.failed_at ? t(".failed_at") : sync.syncing_at ? t(".syncing_at") : sync.pending_at ? t(".pending_at") : t(".created_at") %>
            <div class="flex justify-between py-1.5 border-b border-secondary">
              <dt class="text-sm text-secondary"><%= relevant_label %></dt>
              <dd class="text-sm <%= sync.failed_at ? 'text-destructive' : 'text-primary' %>"><%= relevant_timestamp.strftime('%b %d, %Y %H:%M:%S') %></dd>
            </div>

            <% if sync.error.present? %>
              <div class="flex justify-between py-1.5 border-b border-secondary">
                <dt class="text-sm text-secondary"><%= t(".error") %></dt>
                <dd class="text-sm text-destructive wrap-break-word max-w-md text-right"><%= sync.error %></dd>
              </div>
            <% end %>
          </dl>
        </div>

        <%# Error Screenshot Section %>
        <% if sync.error_screenshot.attached? %>
          <div>
            <h3 class="text-sm font-medium text-primary mb-2"><%= t(".error_screenshot_section") %></h3>
            <div class="bg-container-inset rounded-lg p-3">
              <%= image_tag sync.error_screenshot, class: "w-full h-auto rounded border border-secondary", alt: "Error screenshot" %>
              <div class="mt-2 flex gap-2">
                <%= link_to rails_blob_path(sync.error_screenshot, disposition: "attachment"), class: "text-xs text-primary hover:underline inline-flex items-center gap-1", download: sync.error_screenshot.filename.to_s do %>
                  <%= icon('download', size: 'xs') %>
                  <%= t(".download_screenshot") %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <%# Window Section %>
        <% if sync.data.present? && (sync.data["window_start_date"].present? || sync.data["window_end_date"].present?) %>
          <div>
            <h3 class="text-sm font-medium text-primary mb-2"><%= t(".window_section") %></h3>
            <dl class="space-y-1">
              <div class="flex justify-between py-1.5 border-b border-secondary">
                <dt class="text-sm text-secondary"><%= t(".sync_window") %></dt>
                <dd class="text-sm text-primary">
                  <%= sync.data["window_start_date"].present? ? l(Date.parse(sync.data["window_start_date"])) : '—' %>
                  <span class="text-secondary mx-1">→</span>
                  <%= sync.data["window_end_date"].present? ? l(Date.parse(sync.data["window_end_date"])) : '—' %>
                </dd>
              </div>
            </dl>
          </div>
        <% end %>

        <%# Sync Stats Section %>
        <% if sync.sync_stats.present? && sync.sync_stats.any? %>
          <div>
            <h3 class="text-sm font-medium text-primary mb-2"><%= t(".sync_stats_section") %></h3>
            <dl class="space-y-1">
              <% sync.sync_stats.each do |key, value| %>
                <div class="flex justify-between py-1.5 border-b border-secondary">
                  <dt class="text-sm text-secondary"><%= key.humanize %></dt>
                  <dd class="text-sm font-medium text-primary"><%= value %></dd>
                </div>
              <% end %>
              <% if sync.data.present? && sync.data["blocked_transactions"].present? %>
                <div class="flex justify-between py-1.5 border-b border-secondary">
                  <dt class="text-sm text-secondary"><%= t(".blocked_transactions") %></dt>
                  <dd class="text-sm font-medium text-primary">
                    <%= sync.data["blocked_transactions"].count %>
                    <% if sync.data["account_details"].present? && sync.data["account_details"]["blocked_amount"].present? && sync.data["account_details"]["blocked_amount"].to_f > 0 %>
                      (<%= format_money(Money.new(-sync.data["account_details"]["blocked_amount"].to_f, priorbank_account.currency)) %>)
                    <% end %>
                  </dd>
                </div>
              <% end %>
            </dl>
          </div>
        <% end %>

        <%# Transaction Details %>
        <% if sync.data.present? && (sync.data["built_entries"].present? || sync.data["built_transfers"].present? || sync.data["duplicates"].present? || sync.data["blocked_transactions"].present?) %>
          <details class="group">
            <summary class="cursor-pointer list-none">
              <h3 class="text-sm font-medium text-primary mb-2 inline-flex items-center gap-2">
                <%= t(".transaction_details_section") %>
                <%= icon('chevron-down', size: 'sm', class: 'group-open:rotate-180 transition-transform') %>
              </h3>
            </summary>
            <div class="space-y-4">
              <%# Imported Transactions %>
              <% if sync.data["built_entries"].present? && sync.data["built_entries"].any? %>
                <div>
                  <h4 class="text-xs font-semibold text-primary mb-2"><%= t(".imported_transactions", count: sync.data["built_entries"].count) %></h4>
                  <div class="space-y-2 max-h-96 overflow-y-auto">
                    <% sync.data["built_entries"].sort_by { |e| Date.parse(e["date"]) rescue Date.today }.reverse.each do |entry| %>
                      <div class="flex justify-between items-start py-2 px-3 bg-success/5 rounded border border-success/20">
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-primary truncate"><%= entry["name"] %></p>
                          <p class="text-xs text-secondary"><%= format_date(entry["date"]) %></p>
                        </div>
                        <p class="text-sm font-medium ml-2 <%= entry['amount'].to_f.negative? ? 'text-green-600' : 'text-primary' %>">
                          <%= format_money(Money.new(-entry["amount"].to_f, entry["currency"])) %>
                        </p>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <%# Imported Transfers %>
              <% if sync.data["built_transfers"].present? && sync.data["built_transfers"].any? %>
                <div>
                  <h4 class="text-xs font-semibold text-primary mb-2"><%= t(".imported_transfers", count: sync.data["built_transfers"].count / 2) %></h4>
                  <div class="space-y-2 max-h-96 overflow-y-auto">
                    <% sync.data["built_transfers"].each_slice(2).sort_by { |outflow, _| Date.parse(outflow["date"]) rescue Date.today }.reverse.each do |outflow, inflow| %>
                      <div class="py-2 px-3 bg-success/5 rounded border border-success/20">
                        <div class="flex justify-between items-start mb-1">
                          <div class="flex-1 min-w-0">
                            <p class="text-xs text-secondary"><%= t(".from") %>:</p>
                            <p class="text-sm font-medium text-primary truncate"><%= outflow["name"] %></p>
                          </div>
                          <p class="text-sm font-medium text-primary ml-2">
                            <%= format_money(Money.new(-outflow["amount"].to_f, outflow["currency"])) %>
                          </p>
                        </div>
                        <div class="flex justify-between items-start">
                          <div class="flex-1 min-w-0">
                            <p class="text-xs text-secondary"><%= t(".to") %>:</p>
                            <p class="text-sm font-medium text-primary truncate"><%= inflow["name"] %></p>
                          </div>
                          <p class="text-xs text-secondary ml-2"><%= format_date(outflow["date"]) %></p>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <%# Skipped Duplicates %>
              <% if sync.data["duplicates"].present? && sync.data["duplicates"].any? %>
                <div>
                  <h4 class="text-xs font-semibold text-secondary mb-2"><%= t(".skipped_duplicates", count: sync.data["duplicates"].count) %></h4>
                  <div class="space-y-2 max-h-96 overflow-y-auto">
                    <% sync.data["duplicates"].sort_by { |d| Date.parse(d["date"]) rescue Date.today }.reverse.each do |duplicate| %>
                      <div class="flex justify-between items-start py-2 px-3 bg-secondary/5 rounded border border-secondary/20">
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-secondary truncate"><%= duplicate["name"] %></p>
                          <p class="text-xs text-secondary"><%= format_date(duplicate["date"]) %></p>
                        </div>
                        <p class="text-sm font-medium ml-2 <%= duplicate['amount'].to_f.negative? ? 'text-green-600' : 'text-secondary' %>">
                          <%= format_money(Money.new(-duplicate["amount"].to_f, duplicate["currency"])) %>
                        </p>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <%# Blocked Transactions %>
              <% if sync.data["blocked_transactions"].present? && sync.data["blocked_transactions"].any? %>
                <div>
                  <h4 class="text-xs font-semibold text-warning mb-2"><%= t(".blocked_transactions_detail", count: sync.data["blocked_transactions"].count) %></h4>
                  <div class="space-y-2 max-h-96 overflow-y-auto">
                    <% sync.data["blocked_transactions"].sort_by { |b| Date.parse(b["date"]) rescue Date.today }.reverse.each do |blocked| %>
                      <div class="flex justify-between items-start py-2 px-3 bg-warning/5 rounded border border-warning/20">
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-primary truncate"><%= blocked["name"] %></p>
                          <p class="text-xs text-secondary"><%= format_date(blocked["date"]) %></p>
                        </div>
                        <p class="text-sm font-medium ml-2 <%= blocked['amount'].to_f.negative? ? 'text-green-600' : 'text-warning' %>">
                          <%= format_money(Money.new(-blocked["amount"].to_f, blocked["currency"])) %>
                        </p>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </details>
        <% end %>

        <%# Sync Steps Section %>
        <% if sync.data.present? && sync.data["steps"].present? && sync.data["steps"].any? %>
          <details class="group">
            <summary class="cursor-pointer list-none">
              <h3 class="text-sm font-medium text-primary mb-2 inline-flex items-center gap-2">
                <%= t(".steps_section") %>
                <%= icon('chevron-down', size: 'sm', class: 'group-open:rotate-180 transition-transform') %>
              </h3>
            </summary>
            <div class="space-y-1 max-h-96 overflow-y-auto">
              <% sync.data["steps"].each_with_index do |step, index| %>
                <div class="flex items-start gap-2 py-2 px-3 rounded <%= step['status'] == 'error' ? 'bg-destructive/5' : step['status'] == 'success' ? 'bg-success/5' : 'bg-container-inset' %>">
                  <div class="shrink-0 mt-0.5">
                    <% if step['status'] == 'success' %>
                      <%= icon('check-circle', size: 'sm', class: 'text-success') %>
                    <% elsif step['status'] == 'error' %>
                      <%= icon('x-circle', size: 'sm', class: 'text-destructive') %>
                    <% elsif step['status'] == 'in_progress' %>
                      <%= icon('loader', size: 'sm', class: 'text-warning') %>
                    <% else %>
                      <%= icon('circle', size: 'sm', class: 'text-secondary') %>
                    <% end %>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between gap-2">
                      <p class="text-xs font-medium <%= step['status'] == 'error' ? 'text-destructive' : 'text-primary' %>">
                        <%= step['step'].humanize %>
                      </p>
                      <% if step['timestamp'].present? %>
                        <time class="text-xs text-secondary whitespace-nowrap">
                          <%= Time.parse(step['timestamp']).strftime('%H:%M:%S') rescue step['timestamp'] %>
                        </time>
                      <% end %>
                    </div>
                    <% if step['message'].present? %>
                      <p class="text-xs <%= step['status'] == 'error' ? 'text-destructive' : 'text-secondary' %> mt-0.5">
                        <%= step['message'] %>
                      </p>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </details>
        <% end %>

        <%# Raw Data Section (collapsed by default) %>
        <% if sync.data.present? && sync.data.any? %>
          <details class="group">
            <summary class="cursor-pointer list-none">
              <h3 class="text-sm font-medium text-primary mb-2 inline-flex items-center gap-2">
                <%= t(".raw_data_section") %>
                <%= icon('chevron-down', size: 'sm', class: 'group-open:rotate-180 transition-transform') %>
              </h3>
            </summary>
            <div class="bg-container-inset rounded-lg p-3 max-h-60 overflow-auto mt-2">
              <pre class="text-xs text-primary"><%= JSON.pretty_generate(sync.data) %></pre>
            </div>
          </details>
        <% end %>

        <%# Parent/Children Info %>
        <% if sync.parent.present? || sync.children.any? %>
          <div>
            <h3 class="text-sm font-medium text-primary mb-2"><%= t(".hierarchy_section") %></h3>
            <dl class="space-y-1">
              <% if sync.parent.present? %>
                <div class="flex justify-between py-1.5 border-b border-secondary">
                  <dt class="text-sm text-secondary"><%= t(".parent_sync") %></dt>
                  <dd class="text-sm text-primary">
                    <%= sync.parent.syncable_type %> (<%= sync.parent.status %>)
                  </dd>
                </div>
              <% end %>

              <% if sync.children.any? %>
                <div class="py-1.5 border-b border-secondary">
                  <dt class="text-sm text-secondary mb-2"><%= t(".child_syncs", count: sync.children.count) %></dt>
                  <dd class="space-y-1">
                    <% sync.children.each do |child| %>
                      <div class="text-xs text-primary bg-container-inset rounded px-2 py-1">
                        <%= child.syncable_type %> - <%= child.status %>
                      </div>
                    <% end %>
                  </dd>
                </div>
              <% end %>
            </dl>
          </div>
        <% end %>
        </div>
      </div>
    <% else %>
      <div class="text-center py-8">
        <p class="text-secondary"><%= t(".no_sync_data") %></p>
      </div>
    <% end %>
  <% end %>
<% end %>
