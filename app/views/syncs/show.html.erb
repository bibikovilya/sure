<%= content_for :previous_path, syncs_path %>

<div class="flex items-center justify-between mb-6">
  <div>
    <h1 class="text-xl font-medium text-primary"><%= t(".title") %></h1>
    <p class="text-sm text-secondary mt-1">
      <% if @sync.syncable.present? %>
        <%= @sync.syncable.name %>
      <% end %>
      Â· <%= @sync.created_at.strftime("%b %-d, %Y at %l:%M %p") %>
    </p>
  </div>

  <%= sync_status_badge(@sync, size: :sm) %>
</div>

<div class="bg-container shadow-border-xs rounded-xl p-4 space-y-6">
  <% if @sync.window_start_date || @sync.window_end_date %>
    <div>
      <h2 class="text-sm font-medium text-primary mb-2"><%= t(".sync_window") %></h2>
      <div class="text-sm text-secondary">
        <% if @sync.window_start_date && @sync.window_end_date %>
          <%= @sync.window_start_date.strftime("%b %-d, %Y") %> - <%= @sync.window_end_date.strftime("%b %-d, %Y") %>
        <% elsif @sync.window_start_date %>
          <%= t(".from") %> <%= @sync.window_start_date.strftime("%b %-d, %Y") %>
        <% elsif @sync.window_end_date %>
          <%= t(".until") %> <%= @sync.window_end_date.strftime("%b %-d, %Y") %>
        <% end %>
      </div>
    </div>
  <% end %>

  <div class="py-4 border-t border-b border-alpha-black-100">
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <span class="text-secondary"><%= t(".created_at") %>:</span>
        <span class="text-primary ml-1"><%= @sync.created_at.strftime("%b %-d, %Y at %l:%M:%S %p") %></span>
      </div>
      <% if @sync.syncing_at %>
        <div>
          <span class="text-secondary"><%= t(".syncing_at") %>:</span>
          <span class="text-primary ml-1"><%= @sync.syncing_at.strftime("%b %-d, %Y at %l:%M:%S %p") %></span>
        </div>
      <% end %>
      <% if @sync.completed_at %>
        <div>
          <span class="text-secondary"><%= t(".completed_at") %>:</span>
          <span class="text-primary ml-1"><%= @sync.completed_at.strftime("%b %-d, %Y at %l:%M:%S %p") %></span>
        </div>
      <% end %>
      <% if @sync.completed_at && @sync.syncing_at %>
        <div>
          <span class="text-secondary"><%= t(".total_duration") %>:</span>
          <span class="text-primary ml-1">
            <%= (@sync.completed_at - @sync.syncing_at).to_i.seconds.inspect %>
          </span>
        </div>
      <% end %>
      <% if @sync.failed_at %>
        <div>
          <span class="text-secondary"><%= t(".failed_at") %>:</span>
          <span class="text-primary ml-1"><%= @sync.failed_at.strftime("%b %-d, %Y at %l:%M:%S %p") %></span>
        </div>
      <% end %>
    </div>
  </div>

  <% if @sync.error.present? %>
    <div>
      <h2 class="text-sm font-medium text-destructive mb-2"><%= t(".error") %></h2>
      <div class="text-sm text-destructive bg-red-500/5 border border-red-500/20 rounded-lg p-3">
        <%= @sync.error %>
      </div>
    </div>
  <% end %>

  <% if @sync.data && @sync.data["steps"]&.any? %>
    <div>
      <h2 class="text-sm font-medium text-primary mb-4"><%= t(".sync_steps") %></h2>
      <div class="space-y-2">
        <% @sync.data["steps"].each_with_index do |step, index| %>
          <%
            current_time = step["timestamp"] ? Time.parse(step["timestamp"]) : nil
            next_step = @sync.data["steps"][index + 1]
            next_time = next_step && next_step["timestamp"] ? Time.parse(next_step["timestamp"]) : nil
            duration = current_time && next_time ? (next_time - current_time) : nil
          %>
          <div class="border border-alpha-black-100 rounded-lg p-4 bg-container-inset">
            <div class="flex items-start gap-3">
              <div class="shrink-0 mt-0.5">
                <% if step["status"] == "success" %>
                  <span class="flex items-center justify-center w-6 h-6 rounded-full bg-green-500/10 text-green-500">
                    <%= icon("check", class: "w-4 h-4") %>
                  </span>
                <% elsif step["status"] == "error" %>
                  <span class="flex items-center justify-center w-6 h-6 rounded-full bg-red-500/10 text-red-500">
                    <%= icon("x", class: "w-4 h-4") %>
                  </span>
                <% elsif step["status"] == "in_progress" %>
                  <span class="flex items-center justify-center w-6 h-6 rounded-full bg-orange-500/10 text-orange-500">
                    <%= icon("loader", class: "w-4 h-4 spin") %>
                  </span>
                <% else %>
                  <span class="flex items-center justify-center w-6 h-6 rounded-full bg-gray-500/10 text-secondary">
                    <%= icon("circle", class: "w-4 h-4") %>
                  </span>
                <% end %>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex-1">
                    <h3 class="text-sm font-medium text-primary"><%= step["step"] %></h3>
                    <p class="text-sm text-secondary mt-1"><%= step["message"] %></p>
                  </div>
                  <div class="text-right">
                    <% if step["timestamp"] %>
                      <span class="text-xs text-secondary whitespace-nowrap block">
                        <%= current_time.strftime("%l:%M:%S %p") %>
                      </span>
                    <% end %>
                    <% if duration %>
                      <span class="text-xs text-secondary whitespace-nowrap block mt-1">
                        <%= duration < 1 ? "< 1s" : "#{duration.round}s" %>
                      </span>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="text-center py-8">
      <p class="text-sm text-secondary"><%= t(".no_steps") %></p>
    </div>
  <% end %>
</div>
